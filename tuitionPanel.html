<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tuition Panel - The Academic Care</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  h1, h2 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  table, th, td { border: 1px solid #aaa; }
  th, td { padding: 5px; text-align: left; }
  button { margin: 2px; }
  .paid { background-color: #4CAF50; color: white; }
  .break { background-color: #800080; color: white; }
</style>
</head>
<body>

<h1>The Academic Care</h1>
<h2>Tuition Management</h2>

<button id="backBtn">Back to Admin Panel</button>
<button id="logoutBtn">Logout</button>

<h3>Student ID: <span id="currentStudentId"></span></h3>

<table id="tuitionTable">
  <tr>
    <th>Month</th>
    <th>Status</th>
    <th>Date | Method</th>
    <th>Action</th>
  </tr>
</table>

<script type="module">
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
import { logout } from "./script.js";

const db = getDatabase();
const studentId = localStorage.getItem("currentStudentId");
document.getElementById("currentStudentId").innerText = studentId;

// Back to admin panel
document.getElementById("backBtn").addEventListener("click", () => {
  window.location.href = "adminPanel.html";
});

// Logout
document.getElementById("logoutBtn").addEventListener("click", logout);

// Load Tuition Table
async function loadTuition(){
  const snapshot = await get(ref(db, `tuition/${studentId}`));
  const tuition = snapshot.val() || {};
  const container = document.getElementById("tuitionTable");
  container.innerHTML = `
    <tr>
      <th>Month</th>
      <th>Status</th>
      <th>Date | Method</th>
      <th>Action</th>
    </tr>`;

  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const todayMonth = new Date().getMonth();

  monthNames.forEach((month,i) => {
    const status = tuition[month]?.status || "";
    const date = tuition[month]?.date || "";
    const method = tuition[month]?.method || "";

    let actionButtons = "";
    if(!status && i <= todayMonth){
      actionButtons = `<button onclick="markPaid('${month}')" class="paid">Mark Paid</button>
                       <button onclick="markBreak('${month}')" class="break">Mark Break</button>`;
    } else if(status){
      actionButtons = `<button onclick="undoStatus('${month}')">Undo</button>`;
    }

    container.innerHTML += `<tr>
      <td>${month}</td>
      <td>${status}</td>
      <td>${date} | ${method}</td>
      <td>${actionButtons}</td>
    </tr>`;
  });
}

// Mark Paid
window.markPaid = async (month) => {
  const method = prompt("Enter Payment Method:");
  if(!method) return;
  const date = new Date().toLocaleDateString();
  await update(ref(db, `tuition/${studentId}/${month}`), {status:"Paid", date:date, method:method});
  loadTuition();
}

// Mark Break
window.markBreak = async (month) => {
  await update(ref(db, `tuition/${studentId}/${month}`), {status:"Break", date:"", method:""});
  loadTuition();
}

// Undo
window.undoStatus = async (month) => {
  await update(ref(db, `tuition/${studentId}/${month}`), {status:"", date:"", method:""});
  loadTuition();
}

// Initial Load
loadTuition();
</script>

</body>
</html>
